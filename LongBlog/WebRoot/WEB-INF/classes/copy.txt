<%@page import="dao.CategoryDao"%>
<%@page import="beans.Category"%>
<%@page import="dao.BlogsDao"%>
<%@page import="util.OtherUtil"%>
<%@page import="beans.Blogs"%>
<%@page import="util.JdbcUtil"%>
<%@page import="java.sql.DriverManager"%>
<%@page import="java.sql.ResultSet"%>
<%@page import="java.sql.Statement"%>
<%@page import="java.sql.Connection"%>
<%@ page language="java" import="java.util.*" pageEncoding="utf-8"%>
<%
String path = request.getContextPath();
String basePath = request.getScheme()+"://"+request.getServerName()+":"+request.getServerPort()+path+"/";
%>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <base href="<%=basePath%>">
    
    <title>Long Bro的博客</title>
	<meta http-equiv="pragma" content="no-cache">
	<meta http-equiv="cache-control" content="no-cache">
	<meta http-equiv="expires" content="0">    
	<meta http-equiv="keywords" content="Long Bro博客古典系列之——江南墨卷">
	<meta http-equiv="description" content="Long Bro博客古典系列之——江南墨卷">
	<link href="css/base.css" rel="stylesheet">
    <link href="css/index.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet"><!-- 内应该有pageList的css -->
    <!--[if lt IE 9]>
    <script src="js/modernizr.js"></script>
    <![endif]-->
    <script type="text/javascript" src="js/jquery.js"></script>
  </head>
  
  
<body>
<div class="topnav">
    <a href="http://longqcloud.cn:1016/LongBlog" target="_blank">Long Bro博客</a>——查看其它<a href="http://longqcloud.cn:1016/love/yinger3" target="_blank">Long Bro and his YingEr</a>
</div>
<div id="wrapper">
 
 
    <%@include file="header.jsp" %>
   
   <div class="jztop"></div>
  <div class="container">
    <div class="bloglist f_l">
      
      <%
        
        String pageId=request.getParameter("pageId");
        int pageI;//当前页码
        if("1".equals(pageId)){
            pageI=1;
        }else if("2".equals(pageId)){
            pageI=2;
        }else if("3".equals(pageId)){
            pageI=3;
        }else if("4".equals(pageId)){
            pageI=4;
        }else if("5".equals(pageId)){
            pageI=5;
        }else if("6".equals(pageId)){
            pageI=6;
        }else if("7".equals(pageId)){
            pageI=7;
        }else if("8".equals(pageId)){
            pageI=8;
        }else if("9".equals(pageId)){
            pageI=9;
        }else if("10".equals(pageId)){
            pageI=10;
        }else if("11".equals(pageId)){
            pageI=11;
        }else if("12".equals(pageId)){
            pageI=12;
        }else if("13".equals(pageId)){
            pageI=13;
        }else{
            pageI=1;
        } 
        
        /* if(("").equals(pageId)){//pageId中有值
            pageI=1;
            System.out.print("执行了1");
        }else{
            System.out.print("执行了2");
            pageI=Integer.parseInt(pageId);
            //pageI=1;
        } */
         
        int num=0;//库中博客的数量
        int pages=0;//博客页数
        BlogsDao blogsDao=new BlogsDao();
        num=blogsDao.queryBlogsNum();//库中博客数量
        
        //每页五篇，计算出页数
        if(num%5==0){
             pages=num/5;
        }else{
             pages=num/5+1;
        } 
        
        String require=" order by b_Id desc limit "+((pageI-1)*5)+",5";
        ArrayList blogs= blogsDao.queryBlogs(require);//查询到指定条件的博客信息
        CategoryDao categoryDao=new CategoryDao();
        for(int i=0;i<blogs.size();i++){
            Blogs blog=(Blogs)blogs.get(i);
            int id=blog.getId();
            String title=blog.getTitle();
            String content=blog.getContent();
            String time=blog.getTime();
            String author=blog.getAuthor();
            String imgPath="images/yinger/"+blog.getImgPath()+".jpg";
            int readNum=blog.getViewNum();
            int comment=blog.getComment();
            int c_Id=blog.getCat_Id();
            //查询类别id对应的类别名
            String cat_Name=categoryDao.queryCatNameById(c_Id);
            if(content.length()>88){//博客较长，只显示66个字符，后面跟......
                 content=content.substring(0,88)+"......";
            }
                 out.print("<h3><a>"+title+"</a></h3>");
                 out.print("<figure><img  style='width:140px;height:120px;border-radius:50%;' src="+imgPath+" alt='"+imgPath+"' title='发布博文后，系统随机分配的图片'></figure>");
                 
                 out.print("<ul>");
                 out.print("<p>"+content+"</p>");
                 out.print("<a title=\""+title+"\" href=\"detailblog.jsp?id="+id+"\" class=\"readmore\">阅读全文&gt;&gt;</a>");
                 out.print("</ul>");
                 
                 out.print(" <p   class=\"dateview\"><span class=\"spanm\">"+
                 time+"</span><span  class=\"spanm\">作者："+author+
                 "</span><span  class=\"spanm\">个人博客：[<a href='cat_search.jsp?id="+c_Id+"'>"+cat_Name+"</a>]</span><span class=\"viewNum\">"
                 +readNum+"</span><span class='commentNum'>"+comment+"</span></p>");
            
        }
        
             
             
        /* try{
        
             con=JdbcUtil.getConnection();
             st=con.createStatement();
             
             //第一页1,5  第二页6,5，第三页11,5    注：limit后面第一个为起始的序号（0开始），第二个参数为查询的个数
             String sql="select * from blogs order by b_Id desc limit "+((pageI-1)*5)+",5";
             
             rs=st.executeQuery(sql);
             while(rs.next()){//b_Id, b_Title, b_Content, b_Time, b_Author
                 int id=rs.getInt("b_Id"); //根据id来查看某条博客的全部内容
                 String title=rs.getString("b_Title");
                 String content=rs.getString("b_Content");
                 String time=rs.getString("b_Time");
                 String author=rs.getString("b_Author");
                 String imgPath="images/yinger/"+rs.getString("b_ImagePath")+".jpg";
                 int readNum=rs.getInt("b_ViewNum");
                 int comment=rs.getInt("b_ComNum");
                 int c_Id=rs.getInt("cat_Id");
                 //查询该博客类别id的类别名
                 String sel="select cat_Name from category where cat_Id="+c_Id+";";
                 Statement st1=con.createStatement();
                 ResultSet rs1=st1.executeQuery(sel);//此处需定义一新的结果集
                 String cat_Name="";
                 if(rs1.next()){
                    cat_Name=rs1.getString("cat_Name");
                 }
                 //num=rs.getRow();//可获得搜索的行数
                 if(content.length()>88){//博客较长，只显示66个字符，后面跟......
                     content=content.substring(0,88)+"......";
                 }
                 out.print("<h3><a>"+title+"</a></h3>");
                 out.print("<figure><img  style='width:140px;height:120px;border-radius:50%;' src="+imgPath+" alt='"+imgPath+"' title='发布博文后，系统随机分配的图片'></figure>");
                 
                 out.print("<ul>");
                 out.print("<p>"+content+"</p>");
                 out.print("<a title=\""+title+"\" href=\"detailblog.jsp?id="+id+"\" class=\"readmore\">阅读全文&gt;&gt;</a>");
                 out.print("</ul>");
                 
                 out.print(" <p   class=\"dateview\"><span class=\"spanm\">"+
                 time+"</span><span  class=\"spanm\">作者："+author+
                 "</span><span  class=\"spanm\">个人博客：[<a href='cat_search.jsp?id="+c_Id+"'>"+cat_Name+"</a>]</span><span class=\"viewNum\">"
                 +readNum+"</span><span class='commentNum'>"+comment+"</span></p>");
             }
             
             //每页五篇，计算出页数
             if(num%5==0){
                pages=num/5;
             }else{
                pages=num/5+1;
             }  */
             
         
       %>     
 
      
    </div>
     <div class="r_box f_r">
      <%
        //控制图片每8秒换一张
        
        //每次进入，随机放置一张图片
        Random ran=new Random();
        int p=ran.nextInt(11);
        if(p==0){
            out.write("<h3 class=\"tit\">"+OtherUtil.love0+"</h3>");
        }else if(p==1){
            out.write("<h3 class=\"tit\">"+OtherUtil.love1+"</h3>");
        }else if(p==2){
            out.write("<h3 class=\"tit\">"+OtherUtil.love2+"</h3>");
        }else if(p==3){
            out.write("<h3 class=\"tit\">"+OtherUtil.love3+"</h3>");
        }else if(p==4){
            out.write("<h3 class=\"tit\">"+OtherUtil.love4+"</h3>");
        }else if(p==5){
            out.write("<h3 class=\"tit\">"+OtherUtil.love5+"</h3>");
        }else if(p==6){
            out.write("<h3 class=\"tit\">"+OtherUtil.love6+"</h3>");
        }else if(p==7){
            out.write("<h3 class=\"tit\">"+OtherUtil.love7+"</h3>");
        }else if(p==8){
            out.write("<h3 class=\"tit\">"+OtherUtil.love8+"</h3>");
        }else if(p==9){
            out.write("<h3 class=\"tit\">"+OtherUtil.love9+"</h3>");
        }else if(p==10){
            out.write("<h3 class=\"tit\">"+OtherUtil.love10+"</h3>");
        }else if(p==11){
            out.write("<h3 class=\"tit\">"+OtherUtil.love11+"</h3>");
        }
      %>
      
      <div class="ad" > <img style="width:150px;height:120px;" src="images/yinger/love<%=p%>.jpg" > </div>
    
     <div class="tuwen">
        <h3 class="tit">博客分类</h3>
        
        <%
           //加载博客类别         注意，如果加上泛型即ArrayList<Category>，下面不用强制转化；如果直接用ArrayList，则需强制转换
           ArrayList categories=categoryDao.queryCategories();
           for(int i=0;i<categories.size();i++){
                Category category=(Category)categories.get(i);
                int cat_Id=category.getCat_Id();      
                String cat_Name=category.getCat_Name();
                int cat_Num=category.getCat_Num();
                
                out.write("<ul>");
               out.write("<li><p><a href='cat_search.jsp?id="+cat_Id+"'>"+cat_Name+"</a>&nbsp;共("+cat_Num+")篇</p></li>");
               out.write("<ul>");
           }
            
            
            
            
           /*  String sel="select * from category";
            rs=st.executeQuery(sel);
            
            while(rs.next()){
               String cat_Name=rs.getString("cat_Name");
               int cat_Num=rs.getInt("cat_Num");
               int cat_Id=rs.getInt("cat_Id");
               out.write("<ul>");
               out.write("<li><p><a href='cat_search.jsp?id="+cat_Id+"'>"+cat_Name+"</a>&nbsp;共("+cat_Num+")篇</p></li>");
               out.write("<ul>");
               
            } */
           
          
         %>
        
      </div>
     
     <div class="tuwen">
        <h3 class="tit">日期归类</h3>
        
        <%
           Connection con=null;
           Statement st=null;
           ResultSet rs=null;
           String select="select distinct left(b_Time,10) as y_m  from blogs;";//年月日
           String select1="select distinct left(b_Time,7) as y_m  from blogs;";//年月
           rs=st.executeQuery(select);
           while(rs.next()){
              String y_m=rs.getString("y_m");
              //System.out.println(y_m);
              String se="select count(*) as amo from blogs where b_Time like '%"+y_m+"%'";
              Statement st1=con.createStatement();
              ResultSet rs1=st1.executeQuery(se);
              int amo=0;
              if(rs1.next()){
                  amo=rs1.getInt("amo");
              }
               out.write("<ul>");
               out.write("<li><p><a>"+y_m+"</a>&nbsp;&nbsp共("+amo+")篇</p></li>");
               out.write("<ul>");
               st1.close();
               rs1.close();
           }
         %>
        
       
      </div>
     
      <div class="tuwen">
        <h3 class="tit">阅读量排行</h3>
        <%
            String require1=" order by b_ViewNum desc limit 0,10";
            ArrayList blogs1=blogsDao.queryBlogs(require1);
            for(int i=0;i<blogs1.size();i++){
                Blogs blog1=new Blogs();
                int b_Id=blog1.getId();
                String title=blog1.getTitle();
                int viewNum=blog1.getViewNum();
                
                out.write("<ul>");
                out.write("<li><p>"+(i+1)+".<a href=\"detailblog.jsp?id="+b_Id+"\">"+title+"</a>("+viewNum+")</p></li>");
                out.write("<ul>");
                
            }
           /*  //查询排名前十的博文
            String order="select b_Id,b_Title,b_ViewNum from blogs order by b_ViewNum desc limit 0,10";
            rs=st.executeQuery(order);
            int i=1;
            while(rs.next()){
               int  b_Id=rs.getInt("b_Id");
                String title=rs.getString("b_Title");
               int viewNum=rs.getInt("b_ViewNum");
                out.write("<ul>");
                out.write("<li><p>"+i+".<a href=\"detailblog.jsp?id="+b_Id+"\">"+title+"</a>("+viewNum+")</p></li>");
                out.write("<ul>");
               
                i++;
            } */
             con.close();
            st.close();
            rs.close();
            
         
         %>
        
      </div>
     
     </div>
  
  </div>
  <!-- container代码 结束 -->
  <div class="jzend"></div>
  
  <div class="pagelist">页次：<%=pageI %>/<%=pages %> 每页5篇 共<%=num %>篇
  <%for(int i=1;i<=pages;i++){
         String pageIndex="<a href=\"/LongBlog/index.jsp?pageId="+i+"\">"+i+"</a>";
         out.write(pageIndex);
         //System.out.println(pageIndex);
     } 
  %>
  </div>
  
  <%@include file="footer.jsp" %>
  
  
</div>
</body>
</html>
